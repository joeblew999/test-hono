<!DOCTYPE html>
<html lang="en" data-theme="night">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hono + Datastar Showcase</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'><text y='14' font-size='14'>ðŸ”¥</text></svg>">
    <link href="https://cdn.jsdelivr.net/npm/daisyui@5" rel="stylesheet" type="text/css" />
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <script type="module" src="/datastar.js"></script>
    <style type="text/tailwindcss">
        [data-theme="night"] {
            --color-primary: oklch(65.69% 0.196 277.12);
            --color-primary-content: oklch(98% 0.005 277.12);
        }
        /* Custom styles with no DaisyUI equivalent */
        .count {
            font-size: 5rem;
            font-weight: 700;
            font-variant-numeric: tabular-nums;
            line-height: 1;
            text-align: center;
            margin: 24px 0;
            transition: color 0.2s;
        }
        .count.positive { color: oklch(76.8% 0.233 142.5); }
        .count.negative { color: oklch(70.4% 0.191 22.2); }
        .count.zero { color: oklch(55.4% 0.046 257.4); }
        .indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: oklch(65.69% 0.196 277.12);
            margin-left: 8px;
            animation: pulse 0.6s ease-in-out infinite;
            vertical-align: middle;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }
        .clock-display {
            font-size: 2.5rem;
            font-weight: 700;
            font-variant-numeric: tabular-nums;
            text-align: center;
            letter-spacing: 0.05em;
        }
    </style>
</head>
<body class="bg-base-100">
    <!-- Online Mode Banner (hidden when in local mode) -->
    <div id="online-mode-banner" class="bg-success text-success-content text-center py-2 px-4 text-sm font-medium sticky top-0 z-50 flex items-center justify-center gap-3 flex-wrap" style="display:none">
        <span>&#9889; Online Mode &mdash; Cloudflare D1</span>
        <a href="?local" class="btn btn-xs btn-ghost border border-success-content/30 text-success-content">Go Offline</a>
    </div>
    <!-- Local Mode Banner (hidden by default, shown by JS when ?local is active) -->
    <div id="local-mode-banner" class="bg-warning text-warning-content text-center py-2 px-4 text-sm font-medium sticky top-0 z-50 flex items-center justify-center gap-3 flex-wrap" style="display:none">
        <span>&#9889; Local Mode &mdash; OPFS persistence</span>
        <span id="local-role-badge" class="badge badge-sm badge-outline text-warning-content border-warning-content/50">...</span>
        <span id="local-net-status" class="badge badge-sm badge-outline text-warning-content border-warning-content/50">checking...</span>
        <span id="local-changes" class="badge badge-sm badge-outline text-warning-content border-warning-content/50" style="display:none"></span>
        <button id="local-sync-btn" class="btn btn-xs btn-ghost border border-warning-content/50 text-warning-content" style="display:none">Sync to Server</button>
        <button id="local-exit-btn" class="btn btn-xs btn-ghost border border-warning-content/50 text-warning-content">Go Online</button>
    </div>
    <div class="max-w-4xl mx-auto px-6 py-12"
         data-signals='{"count": 0, "inputValue": 0, "lastKey": "", "isFetching": false, "newNote": "", "noteCount": 0, "noteError": "", "elapsed": 0, "debouncedText": "", "authEmail": "admin@example.com", "authPassword": "admin123", "authName": "Admin", "authUser": "", "authRole": "", "authError": "", "authMode": "signup", "taskTitle": "", "taskDesc": "", "taskFilter": "", "taskCount": 0, "taskError": "", "sessionCount": 0, "revokeSessionToken": ""}'
         data-computed:abscount="Math.abs($count)"
         data-computed:parity="$count % 2 === 0 ? 'even' : 'odd'"
         data-computed:sign="$count > 0 ? 'positive' : $count < 0 ? 'negative' : 'zero'"
         data-init="@get('/api/counter')"
         data-on:keydown.window="
            if ($evt.key === '+' || $evt.key === '=') { $lastKey = '+'; @post('/api/counter/increment') }
            else if ($evt.key === '-') { $lastKey = '-'; @post('/api/counter/decrement') }
            else if ($evt.key === '0') { $lastKey = '0'; @post('/api/counter/reset') }
         "
    >

        <!-- Header -->
        <header class="text-center mb-12">
            <h1 class="text-2xl font-bold tracking-tight">Hono + Datastar Showcase</h1>
            <p id="page-subtitle" class="text-base-content/50 text-sm">Datastar v1 patterns with OpenAPI content negotiation and D1 persistence</p>
            <div id="tech-badges" class="flex gap-2 justify-center mt-4 flex-wrap">
                <span class="badge badge-outline badge-sm">Hono</span>
                <span class="badge badge-outline badge-sm">Datastar v1 RC.7</span>
                <span class="badge badge-outline badge-sm">Cloudflare D1</span>
                <span class="badge badge-outline badge-sm">Workers</span>
                <span class="badge badge-outline badge-sm">OpenAPI 3.1</span>
                <span class="badge badge-outline badge-sm">Better Auth</span>
                <span class="badge badge-outline badge-sm">MCP</span>
                <span class="badge badge-outline badge-sm">Drizzle ORM</span>
            </div>
            <!-- Auth bar: signed-in state or sign-in link -->
            <div class="header-auth flex items-center justify-center gap-3 mt-3" data-show="$authUser">
                <span class="auth-user-name text-sm text-success font-medium" data-text="'Signed in as ' + $authUser"></span>
                <span class="badge badge-primary badge-sm" data-show="$authRole === 'admin'">ADMIN</span>
                <button class="btn btn-sm btn-ghost" data-on:click="
                    fetch('/api/auth/sign-out', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: '{}' }).then(() => {
                        $authUser = ''; $authRole = ''; $taskCount = 0;
                    })
                ">Sign Out</button>
            </div>
            <div class="header-auth flex items-center justify-center gap-3 mt-3" data-show="!$authUser">
                <a href="/login" class="link link-primary text-sm font-medium">Sign In</a>
            </div>
        </header>

        <!-- Check auth session on page load -->
        <div data-init="@get('/api/session')"></div>

        <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
        <!--  GROUP 1: COUNTER                       -->
        <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
        <div class="text-xs font-semibold uppercase tracking-widest text-base-content/40 mb-4 pl-1">Counter</div>

        <!-- Counter: main display + controls -->
        <section class="card card-border bg-base-200 p-8 mb-6">
            <h2 class="text-lg font-semibold">Counter
                <span class="indicator" data-show="$isFetching"></span>
            </h2>
            <p class="text-sm text-base-content/50 mb-5 leading-relaxed">
                The core counter backed by D1 (SQLite). Every action is an atomic SQL update.
                <br>
                <span class="badge badge-sm font-mono bg-base-100 text-primary border-base-300 mr-1 mb-1">data-signals</span>
                <span class="badge badge-sm font-mono bg-base-100 text-primary border-base-300 mr-1 mb-1">data-text</span>
                <span class="badge badge-sm font-mono bg-base-100 text-primary border-base-300 mr-1 mb-1">data-on:click</span>
                <span class="badge badge-sm font-mono bg-base-100 text-primary border-base-300 mr-1 mb-1">data-init</span>
                <span class="badge badge-sm font-mono bg-base-100 text-primary border-base-300 mr-1 mb-1">data-class</span>
                <span class="badge badge-sm font-mono bg-base-100 text-primary border-base-300 mr-1 mb-1">data-show</span>
                <span class="badge badge-sm font-mono bg-base-100 text-primary border-base-300 mr-1 mb-1">data-attr</span>
                <span class="badge badge-sm font-mono bg-base-100 text-primary border-base-300 mr-1 mb-1">data-bind</span>
                <span class="badge badge-sm font-mono bg-base-100 text-primary border-base-300 mr-1 mb-1">data-on:keydown.window</span>
            </p>

            <div class="count"
                 data-text="$count"
                 data-class:positive="$count > 0"
                 data-class:negative="$count < 0"
                 data-class:zero="$count === 0"
            ></div>

            <div class="flex gap-3 justify-center flex-wrap">
                <button class="btn btn-outline" data-on:click="@post('/api/counter/decrement')"
                        data-attr:disabled="$isFetching">
                    &minus; Decrement
                </button>
                <button class="btn btn-outline" data-on:click="@post('/api/counter/increment')"
                        data-attr:disabled="$isFetching">
                    + Increment
                </button>
            </div>

            <!-- Set Value -->
            <div class="text-xs font-semibold uppercase tracking-wide text-base-content/60 mt-6 mb-3 pt-5 border-t border-base-300">Set Value</div>
            <div class="flex gap-3 items-center justify-center">
                <input type="number" class="input input-bordered w-30 text-center" data-bind="inputValue" placeholder="0">
                <button class="btn btn-outline" data-on:click="@post('/api/counter/set')">
                    Set Counter
                </button>
            </div>

            <!-- Keyboard Shortcuts -->
            <div class="text-xs font-semibold uppercase tracking-wide text-base-content/60 mt-6 mb-3 pt-5 border-t border-base-300">Keyboard Shortcuts</div>
            <div class="flex gap-6 justify-center flex-wrap">
                <span class="text-sm text-base-content/60"><kbd class="kbd kbd-sm">+</kbd> Increment</span>
                <span class="text-sm text-base-content/60"><kbd class="kbd kbd-sm">-</kbd> Decrement</span>
                <span class="text-sm text-base-content/60"><kbd class="kbd kbd-sm">0</kbd> Reset</span>
            </div>
            <div class="text-center text-sm text-base-content/60 mt-2">
                Last key: <strong data-text="$lastKey || 'none'"></strong>
            </div>
        </section>

        <!-- Counter Insights: computed + messages + reactive bar -->
        <section class="card card-border bg-base-200 p-8 mb-6">
            <h2 class="text-lg font-semibold">Counter Insights</h2>
            <p class="text-sm text-base-content/50 mb-5 leading-relaxed">
                Derived values, conditional messages, and reactive styles â€” all driven by the counter signal.
                <br>
                <span class="badge badge-sm font-mono bg-base-100 text-primary border-base-300 mr-1 mb-1">data-computed</span>
                <span class="badge badge-sm font-mono bg-base-100 text-primary border-base-300 mr-1 mb-1">data-show</span>
                <span class="badge badge-sm font-mono bg-base-100 text-primary border-base-300 mr-1 mb-1">data-style</span>
            </p>

            <!-- Computed Values -->
            <div class="grid grid-cols-1 sm:grid-cols-3 gap-3">
                <div class="bg-base-100 border border-base-300 rounded-lg p-3 text-center">
                    <div class="text-xs text-base-content/50 uppercase tracking-wide mb-1">Absolute</div>
                    <div class="text-2xl font-semibold tabular-nums" data-text="$abscount"></div>
                </div>
                <div class="bg-base-100 border border-base-300 rounded-lg p-3 text-center">
                    <div class="text-xs text-base-content/50 uppercase tracking-wide mb-1">Parity</div>
                    <div class="text-2xl font-semibold tabular-nums" data-text="$parity"></div>
                </div>
                <div class="bg-base-100 border border-base-300 rounded-lg p-3 text-center">
                    <div class="text-xs text-base-content/50 uppercase tracking-wide mb-1">Sign</div>
                    <div class="text-2xl font-semibold tabular-nums" data-text="$sign"></div>
                </div>
            </div>

            <!-- Conditional Messages -->
            <div class="text-xs font-semibold uppercase tracking-wide text-base-content/60 mt-6 mb-3 pt-5 border-t border-base-300">Messages</div>
            <div class="message green alert alert-success text-sm mb-2" data-show="$count > 0">
                Counter is positive
            </div>
            <div class="message red alert alert-error text-sm mb-2" data-show="$count < 0">
                Counter is negative
            </div>
            <div class="message gray alert text-sm mb-2" data-show="$count === 0">
                Counter is zero
            </div>
            <div class="message blue alert alert-info text-sm mb-2" data-show="$count % 2 === 0">
                Even number
            </div>

            <!-- Reactive Progress Bar -->
            <div class="text-xs font-semibold uppercase tracking-wide text-base-content/60 mt-6 mb-3 pt-5 border-t border-base-300">Progress Bar</div>
            <div class="bg-base-100 border border-base-300 rounded-lg h-8 overflow-hidden">
                <div class="bar-fill h-full rounded-lg transition-all duration-300 flex items-center justify-center text-xs font-semibold min-w-6"
                     data-style:width="Math.min(Math.abs($count) * 10, 100) + '%'"
                     data-style:background-color="$count > 0 ? '#4ade80' : $count < 0 ? '#f87171' : '#64748b'"
                     data-text="Math.min(Math.abs($count) * 10, 100) + '%'">
                </div>
            </div>
            <div class="text-center text-sm text-base-content/50 mt-2">
                Each count = 10% width (capped at 100%)
            </div>
        </section>

        <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
        <!--  GROUP 2: NOTES (authenticated)          -->
        <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
        <div class="text-xs font-semibold uppercase tracking-widest text-base-content/40 mt-10 mb-4 pl-1" data-show="$authUser">Notes</div>

        <!-- Notes CRUD (protected) -->
        <section class="card card-border bg-base-200 p-8 mb-6" data-show="$authUser">
            <h2 class="text-lg font-semibold">Notes
                <span class="indicator" data-show="$isFetching"></span>
            </h2>
            <p class="text-sm text-base-content/50 mb-5 leading-relaxed">
                Full CRUD with server-rendered list items. Form submit creates; delete button removes. Server re-renders the full list on each mutation â€” no client-side templating.
                <br>
                <span class="badge badge-sm font-mono bg-base-100 text-primary border-base-300 mr-1 mb-1">@post</span>
                <span class="badge badge-sm font-mono bg-base-100 text-primary border-base-300 mr-1 mb-1">@delete</span>
                <span class="badge badge-sm font-mono bg-base-100 text-primary border-base-300 mr-1 mb-1">datastar-patch-elements</span>
            </p>

            <form class="notes-form flex gap-3 mb-4" data-on:submit="
                if (!$newNote.trim()) { $noteError = 'Note cannot be empty'; return; }
                $noteError = '';
                @post('/api/notes')
            ">
                <input type="text" class="input input-bordered flex-1" data-bind="newNote" placeholder="Add a note...">
                <button type="submit" class="btn btn-primary">Add</button>
            </form>
            <div class="text-sm text-error text-center" data-show="$noteError" data-text="$noteError"></div>

            <ul id="notes-list" class="list-none p-0"
                data-init="@get('/api/notes')">
                <li class="note-empty text-center text-base-content/50 text-sm p-3">Loading...</li>
            </ul>

            <div class="text-center text-sm text-base-content/50 mt-2">
                <span data-text="$noteCount"></span> notes
            </div>
        </section>

        <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
        <!--  GROUP 3: MORE PATTERNS                 -->
        <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
        <div class="text-xs font-semibold uppercase tracking-widest text-base-content/40 mt-10 mb-4 pl-1">More Patterns</div>

        <div class="grid grid-cols-1 sm:grid-cols-2 gap-6">
            <!-- Server Fragment + Side Effects -->
            <section class="card card-border bg-base-200 p-8 mb-0">
                <h2 class="text-lg font-semibold">Server Fragment</h2>
                <p class="text-sm text-base-content/50 mb-5 leading-relaxed">
                    Server renders HTML via SSE <code class="text-primary">datastar-patch-elements</code>. Datastar patches it into the DOM using Idiomorph.
                    <br>
                    <span class="badge badge-sm font-mono bg-base-100 text-primary border-base-300 mr-1 mb-1">datastar-patch-elements</span>
                    <span class="badge badge-sm font-mono bg-base-100 text-primary border-base-300 mr-1 mb-1">data-effect</span>
                </p>

                <div class="bg-base-100 border border-base-300 rounded-lg p-4 text-center min-h-12" id="server-fragment">
                    <span class="text-base-content/50 text-sm">Click to load server-rendered fragment</span>
                </div>
                <div class="flex gap-3 justify-center mt-3">
                    <button class="btn btn-outline" data-on:click="@get('/api/counter/fragment')">
                        Load Fragment
                    </button>
                </div>

                <div data-effect="document.title = `Count: ${$count} | Hono + Datastar`"></div>
                <div class="text-center text-sm text-base-content/50 mt-4 pt-4 border-t border-base-300">
                    Side effect: the browser tab title updates with the count.
                </div>
            </section>

            <!-- Interval Timer -->
            <section class="card card-border bg-base-200 p-8 mb-0">
                <h2 class="text-lg font-semibold">Interval Timer</h2>
                <p class="text-sm text-base-content/50 mb-5 leading-relaxed">
                    Client-side clock that ticks every second. No server requests â€” pure reactive interval.
                    <br>
                    <span class="badge badge-sm font-mono bg-base-100 text-primary border-base-300 mr-1 mb-1">data-on-interval</span>
                    <span class="badge badge-sm font-mono bg-base-100 text-primary border-base-300 mr-1 mb-1">.duration</span>
                </p>

                <div data-on-interval__duration.1s="$elapsed++">
                    <div class="clock-display" data-text="new Date().toLocaleTimeString()"></div>
                    <div class="text-center text-sm text-base-content/50 mt-2">
                        Page open for <strong data-text="$elapsed"></strong> seconds
                    </div>
                </div>
            </section>
        </div>

        <!-- Debounce (full-width below the grid) -->
        <section class="card card-border bg-base-200 p-8 mb-6 mt-6">
            <h2 class="text-lg font-semibold">Debounce</h2>
            <p class="text-sm text-base-content/50 mb-5 leading-relaxed">
                Output updates 500ms after you stop typing. The <code class="text-primary">.debounce</code> modifier handles timing automatically.
                <br>
                <span class="badge badge-sm font-mono bg-base-100 text-primary border-base-300 mr-1 mb-1">.debounce</span>
            </p>

            <div class="flex gap-4 items-center">
                <input type="text" class="input input-bordered flex-1"
                       data-on:input__debounce.500ms="$debouncedText = $evt.target.value"
                       placeholder="Type something...">
                <div class="text-sm text-base-content/60 min-w-30">
                    Debounced: <strong data-text="$debouncedText || '...'"></strong>
                </div>
            </div>
        </section>

        <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
        <!--  GROUP 4: AUTH + TASKS                   -->
        <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
        <div id="auth-tasks-group">
        <div class="text-xs font-semibold uppercase tracking-widest text-base-content/40 mt-10 mb-4 pl-1">Tasks</div>

        <!-- Sign-in prompt for unauthenticated users -->
        <div data-show="!$authUser" class="text-center p-4 text-base-content/50 text-sm">
            <a href="/login" class="link link-primary">Sign in</a> to access Tasks and Admin features.
        </div>

        <!-- Tasks (protected) -->
        <section class="card card-border bg-base-200 p-8 mb-6" data-show="$authUser">
            <h2 class="text-lg font-semibold">Tasks
                <span class="indicator" data-show="$isFetching"></span>
            </h2>
            <p class="text-sm text-base-content/50 mb-5 leading-relaxed">
                Authenticated task CRUD. Same Zod schemas power both this REST API and the MCP tools for AI agents.
                <br>
                <span class="badge badge-sm font-mono bg-base-100 text-primary border-base-300 mr-1 mb-1">Drizzle ORM</span>
                <span class="badge badge-sm font-mono bg-base-100 text-primary border-base-300 mr-1 mb-1">@post / @patch / @delete</span>
                <span class="badge badge-sm font-mono bg-base-100 text-primary border-base-300 mr-1 mb-1">MCP Tools</span>
            </p>

            <form class="task-form flex gap-3 mb-4" data-on:submit="
                if (!$taskTitle.trim()) { $taskError = 'Title is required'; return; }
                $taskError = '';
                @post('/api/tasks')
            ">
                <input type="text" class="input input-bordered flex-1" data-bind="taskTitle" placeholder="Task title...">
                <button type="submit" class="btn btn-primary">Add Task</button>
            </form>
            <div class="text-sm text-error text-center" data-show="$taskError" data-text="$taskError"></div>

            <div class="flex gap-2 mb-4 justify-center">
                <button class="task-filter-btn btn btn-xs btn-outline"
                        data-class:btn-primary="!$taskFilter"
                        data-on:click="$taskFilter = ''; @get('/api/tasks')">All</button>
                <button class="task-filter-btn btn btn-xs btn-outline"
                        data-class:btn-primary="$taskFilter === 'pending'"
                        data-on:click="$taskFilter = 'pending'; @get('/api/tasks?status=pending')">Pending</button>
                <button class="task-filter-btn btn btn-xs btn-outline"
                        data-class:btn-primary="$taskFilter === 'in_progress'"
                        data-on:click="$taskFilter = 'in_progress'; @get('/api/tasks?status=in_progress')">In Progress</button>
                <button class="task-filter-btn btn btn-xs btn-outline"
                        data-class:btn-primary="$taskFilter === 'completed'"
                        data-on:click="$taskFilter = 'completed'; @get('/api/tasks?status=completed')">Completed</button>
            </div>

            <ul id="task-list" class="list-none p-0"
                data-init="@get('/api/tasks')">
                <li class="note-empty text-center text-base-content/50 text-sm p-3">Sign in to see tasks</li>
            </ul>

            <div class="text-center text-sm text-base-content/50 mt-2">
                <span id="task-count-display" data-text="$taskCount">0</span> tasks
            </div>
        </section>

        <!-- Admin Panel (admin role only) -->
        <section class="card card-border bg-base-200 p-8 mb-6" data-show="$authRole === 'admin'">
            <h2 class="text-lg font-semibold">Admin Panel</h2>
            <p class="text-sm text-base-content/50 mb-5 leading-relaxed">
                Manage users via Better Auth admin plugin. Only visible to admin role.
                <br>
                <span class="badge badge-sm font-mono bg-base-100 text-primary border-base-300 mr-1 mb-1">Better Auth Admin</span>
                <span class="badge badge-sm font-mono bg-base-100 text-primary border-base-300 mr-1 mb-1">data-show</span>
                <span class="badge badge-sm font-mono bg-base-100 text-primary border-base-300 mr-1 mb-1">fetch()</span>
            </p>

            <div class="flex gap-3 mb-4 justify-center">
                <button class="btn btn-outline" data-on:click="fetchAdminUsers()">Refresh Users</button>
            </div>

            <ul id="admin-user-list" class="list-none p-0">
                <li class="note-empty text-center text-base-content/50 text-sm p-3">Click "Refresh Users" to load</li>
            </ul>

            <div id="admin-user-count" class="text-center text-sm text-base-content/50 mt-2"></div>

            <script>
                window.fetchAdminUsers = function() {
                    fetch('/api/auth/admin/list-users').then(function(r) {
                        if (!r.ok) throw new Error('Not authorized');
                        return r.json();
                    }).then(function(data) {
                        var list = document.getElementById('admin-user-list');
                        var countEl = document.getElementById('admin-user-count');
                        if (!data.users || !data.users.length) {
                            list.innerHTML = '<li class="note-empty text-center text-base-content/50 text-sm p-3">No users found</li>';
                            countEl.textContent = '0 users';
                            return;
                        }
                        countEl.textContent = data.total + ' users';
                        list.innerHTML = data.users.map(function(u) {
                            return '<li class="task-item flex items-center gap-3 px-3 py-2.5 border-b border-base-300 last:border-b-0" id="admin-user-' + u.id + '">'
                                + '<span class="task-title flex-1 text-sm">' + u.name + ' (' + u.email + ')</span>'
                                + '<span class="badge badge-sm ' + (u.role === 'admin' ? 'badge-info' : 'badge-ghost') + '">' + (u.role || 'user') + '</span>'
                                + '<select onchange="setUserRole(\'' + u.id + '\', this.value)"'
                                + ' class="select select-xs select-bordered">'
                                + '<option value="user"' + ((u.role||'user')==='user' ? ' selected' : '') + '>user</option>'
                                + '<option value="admin"' + (u.role==='admin' ? ' selected' : '') + '>admin</option>'
                                + '</select>'
                                + (u.banned
                                    ? '<button onclick="unbanUser(\'' + u.id + '\')" class="btn btn-xs btn-outline btn-success">Unban</button>'
                                    : '<button onclick="banUser(\'' + u.id + '\')" class="btn btn-xs btn-outline btn-error">Ban</button>')
                                + '</li>';
                        }).join('');
                    }).catch(function(e) {
                        document.getElementById('admin-user-list').innerHTML = '<li class="note-empty text-center text-base-content/50 text-sm p-3">Error: ' + e.message + '</li>';
                    });
                };
                window.setUserRole = function(userId, role) {
                    fetch('/api/auth/admin/set-role', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ userId: userId, role: role })
                    }).then(function() { fetchAdminUsers(); });
                };
                window.banUser = function(userId) {
                    fetch('/api/auth/admin/ban-user', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ userId: userId, banReason: 'Banned by admin' })
                    }).then(function() { fetchAdminUsers(); });
                };
                window.unbanUser = function(userId) {
                    fetch('/api/auth/admin/unban-user', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ userId: userId })
                    }).then(function() { fetchAdminUsers(); });
                };
            </script>
            <div data-effect="if ($authRole === 'admin') { fetchAdminUsers() }"></div>
        </section>

        <!-- My Sessions (protected) -->
        <section class="card card-border bg-base-200 p-8 mb-6" data-show="$authUser">
            <h2 class="text-lg font-semibold">My Sessions
                <span class="indicator" data-show="$isFetching"></span>
            </h2>
            <p class="text-sm text-base-content/50 mb-5 leading-relaxed">
                Active sessions across all your devices. Revoke any session to log it out remotely.
                <br>
                <span class="badge badge-sm font-mono bg-base-100 text-primary border-base-300 mr-1 mb-1">Multi-Session</span>
                <span class="badge badge-sm font-mono bg-base-100 text-primary border-base-300 mr-1 mb-1">SSE Polling</span>
                <span class="badge badge-sm font-mono bg-base-100 text-primary border-base-300 mr-1 mb-1">Remote Revocation</span>
            </p>

            <ul id="session-list" class="list-none p-0"
                data-init="@get('/api/sessions')">
                <li class="note-empty text-center text-base-content/50 text-sm p-3">Loading sessions...</li>
            </ul>

            <div class="text-center text-sm text-base-content/50 mt-2">
                <span data-text="$sessionCount">0</span> active sessions
            </div>
        </section>

        </div><!-- /auth-tasks-group -->

        <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
        <!--  GROUP 5: DEV TOOLS                     -->
        <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
        <div class="text-xs font-semibold uppercase tracking-widest text-base-content/40 mt-10 mb-4 pl-1">Developer Tools</div>

        <!-- Signal Inspector -->
        <section class="card card-border bg-base-200 p-8 mb-6">
            <h2 class="text-lg font-semibold">Signal Inspector</h2>
            <p class="text-sm text-base-content/50 mb-5 leading-relaxed">
                Live JSON dump of every signal in the store. Updates in real-time as you interact with the page.
                <br>
                <span class="badge badge-sm font-mono bg-base-100 text-primary border-base-300 mr-1 mb-1">data-json-signals</span>
            </p>

            <pre class="bg-base-100 border border-base-300 rounded-lg p-4 font-mono text-xs text-base-content/60 overflow-auto max-h-75 leading-relaxed" data-json-signals></pre>
        </section>

        <!-- Footer links -->
        <div class="flex gap-4 justify-center text-sm mt-8">
            <a href="/ui" class="link link-hover text-base-content/50">API Docs</a>
            <a href="/api/doc" class="link link-hover text-base-content/50">OpenAPI Spec</a>
            <a href="/api/counter" class="link link-hover text-base-content/50">API JSON</a>
        </div>

    </div>

    <script>
    // Local-first mode: Web Locks leader election + wa-sqlite OPFS (opt-in via ?local query param)
    // This script runs SYNCHRONOUSLY before Datastar so the fetch override is in place
    // before any data-init SSE connections fire.
    (function() {
        var isLocal = new URLSearchParams(location.search).has('local');

        if (isLocal) {
            // 1. Save original fetch and install override BEFORE Datastar loads
            window.__origFetch = window.fetch.bind(window);
            var ready = new Promise(function(r) { window.__resolveLocal = r; });
            window.fetch = function(input, init) {
                var rawUrl = typeof input === 'string' ? input : (input instanceof URL ? input.href : input.url);
                var url = new URL(rawUrl, location.origin);
                if (url.pathname.startsWith('/api/')) {
                    return ready.then(function(handler) { return handler(input, init); });
                }
                return window.__origFetch(input, init);
            };

            // 2. Load the local-mode module (coordinator + Hono app)
            var s = document.createElement('script');
            s.type = 'module';
            s.src = '/local-mode.js';
            document.head.appendChild(s);

            // 3. Show banner + update DOM
            document.getElementById('local-mode-banner').style.display = '';
            var sub = document.getElementById('page-subtitle');
            if (sub) sub.textContent = 'Datastar v1 patterns with local-first SQLite \u2014 all data in your browser, no server required';
            // Remove auth bar (must remove, not hide, because data-show overrides display)
            document.querySelectorAll('.header-auth').forEach(function(el) { el.remove(); });
            // Swap tech badges for local-mode stack
            var badges = document.getElementById('tech-badges');
            if (badges) badges.innerHTML =
                '<span class="badge badge-outline badge-sm">Hono</span>' +
                '<span class="badge badge-outline badge-sm">Datastar v1 RC.7</span>' +
                '<span class="badge badge-outline badge-sm">wa-sqlite (WASM)</span>' +
                '<span class="badge badge-outline badge-sm">OPFS</span>' +
                '<span class="badge badge-outline badge-sm">Web Worker</span>';
            // Remove auth-dependent sections (tasks, admin, sessions â€” no auth in local mode)
            var authGroup = document.getElementById('auth-tasks-group');
            if (authGroup) authGroup.remove();
            // Remove session check (would 404 in local mode)
            var sessionInit = document.querySelector('[data-init="@get(\'/api/session\')"]');
            if (sessionInit) sessionInit.remove();

            // 4. Real network detection (uses original fetch, bypasses override)
            var netEl = document.getElementById('local-net-status');
            var serverReachable = false;
            function checkServer() {
                var ctrl = new AbortController();
                var timer = setTimeout(function() { ctrl.abort(); }, 3000);
                window.__origFetch('/', { method: 'HEAD', signal: ctrl.signal, cache: 'no-store' })
                    .then(function(r) {
                        clearTimeout(timer);
                        serverReachable = r.ok;
                        netEl.textContent = r.ok ? 'server reachable' : 'server error';
                    })
                    .catch(function() {
                        clearTimeout(timer);
                        serverReachable = false;
                        netEl.textContent = 'server unreachable';
                    });
            }
            checkServer();
            setInterval(checkServer, 10000);

            // 5. Mutation counter polling (goes through our override â†’ Hono app)
            var changesEl = document.getElementById('local-changes');
            var syncBtn = document.getElementById('local-sync-btn');
            function pollStatus() {
                fetch('/api/local/status').then(function(r) { return r.json() }).then(function(d) {
                    if (d.mutations > 0) {
                        changesEl.textContent = d.mutations + ' change' + (d.mutations === 1 ? '' : 's');
                        changesEl.style.display = '';
                        syncBtn.style.display = serverReachable ? '' : 'none';
                    } else {
                        changesEl.style.display = 'none';
                        syncBtn.style.display = 'none';
                    }
                }).catch(function() {});
            }
            setInterval(pollStatus, 2000);
            setTimeout(pollStatus, 500);

            // 6. Sync to server (goes through override â†’ Hono app â†’ uses origFetch internally)
            syncBtn.addEventListener('click', function() {
                syncBtn.textContent = 'Syncing\u2026';
                syncBtn.disabled = true;
                fetch('/api/local/sync', { method: 'POST' }).then(function(r) { return r.json() }).then(function(d) {
                    if (d.synced) {
                        syncBtn.textContent = '\u2714 Synced!';
                        changesEl.style.display = 'none';
                        setTimeout(function() {
                            syncBtn.textContent = 'Sync to Server';
                            syncBtn.style.display = 'none';
                            syncBtn.disabled = false;
                        }, 2000);
                    } else {
                        syncBtn.textContent = '\u2716 Failed';
                        setTimeout(function() { syncBtn.textContent = 'Sync to Server'; syncBtn.disabled = false; }, 2000);
                    }
                }).catch(function() {
                    syncBtn.textContent = '\u2716 Failed';
                    setTimeout(function() { syncBtn.textContent = 'Sync to Server'; syncBtn.disabled = false; }, 2000);
                });
            });

            // 7. Exit local mode (just navigate â€” no SW to unregister)
            document.getElementById('local-exit-btn').addEventListener('click', function() {
                location.href = '/';
            });
        } else {
            // Show online mode banner
            document.getElementById('online-mode-banner').style.display = '';
        }
    })();
    </script>
</body>
</html>
