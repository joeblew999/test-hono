app = 'test-hono-bun'
primary_region = 'sjc'

[build]

[env]
  DB_PATH = '/data/counter.db' # This might become less relevant if Corrosion manages its own DB.
  PORT = '3000'
  USE_CORROSION_DB = 'true'
  # CORROSION_AGENT_URL should point to the internal HTTP address of the corrosion process.
  # Assuming corrosion listens on port 8080 by default in the same VM.
  CORROSION_AGENT_URL = 'http://localhost:8080'
  CORROSION_GOSSIP_PORT = '7946' # Standard gossip protocol UDP port
  BETTER_AUTH_URL = 'https://test-hono-bun.fly.dev'
  # BETTER_AUTH_SECRET set via `fly secrets set`

[processes]
  # Main application process
  app = 'bun run server.ts'
  # Corrosion agent process
  # IMPORTANT: These flags are based on common gossip systems.
  # You MUST verify them against the actual documentation for your 'corrosion' binary.
  # -http-addr: Address for the HTTP API. Our app connects to this.
  # -data-dir: Directory to store its internal SQLite database and other data. Should be on a persistent volume.
  # -gossip-port: The UDP port for the gossip protocol.
  # -join: To discover and join other nodes in the cluster. Uses Fly.io's internal DNS.
  corrosion = 'corrosion -http-addr :8080 -data-dir /data/corrosion_data -gossip-port :$(CORROSION_GOSSIP_PORT) -join $(FLY_APP_NAME).internal:$(CORROSION_GOSSIP_PORT)'

[http_service]
  internal_port = 3000
  force_https = true
  auto_stop_machines = 'stop'
  auto_start_machines = true
  min_machines_running = 0
  processes = ['app'] # Only the 'app' process serves HTTP traffic externally

[[services]]
  internal_port = 7946 # Gossip UDP port
  protocol = "udp"
  processes = ["corrosion"] # Only the 'corrosion' process uses this port
  [[services.ports]]
    port = 7946
    handlers = ["udp"]

[[vm]]
  memory = '256mb'
  cpu_kind = 'shared'
  cpus = 1

[[mounts]]
  source = 'data'
  destination = '/data'
